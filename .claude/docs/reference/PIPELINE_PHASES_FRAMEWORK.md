# FirstMile Deals Pipeline - 7-Phase Operations Framework

Mapping daily sales operations to a structured 7-phase workflow for consistent execution.

---

## Phase 1: Assess State

**Git Equivalent**: `git status`, review recent commits

### Daily Sync Operations
- **Morning (9AM)**: Check pipeline status, overnight changes
- **Chrome MCP**: Extract Superhuman emails → `superhuman_emails.json`
- **HubSpot Query**: Fetch deals with Owner ID + Pipeline ID filters

### Key Processes
```python
# Fetch current pipeline state
payload = {
    "filterGroups": [{
        "filters": [
            {"propertyName": "hubspot_owner_id", "operator": "EQ", "value": "699257003"},
            {"propertyName": "pipeline", "operator": "EQ", "value": "8bd9336b-4767-4e67-9fe2-35dfcad7c8be"}
        ]
    }],
    "properties": ["dealname", "dealstage", "amount", "monthly_volume__c", "hs_next_step"],
    "limit": 100
}
```

### Outputs
- Pipeline snapshot (40 active deals, $85M value)
- Stage distribution
- Email inbox summary
- Task status (overdue, due today)

---

## Phase 2: Analyze Changes

**Git Equivalent**: Categorize changes, identify primary purpose

### Deal Hygiene Audit
- **Missing fields**: amount, monthly_volume__c, closedate, hs_next_step
- **Stale deals**: No activity in 30+ days
- **Overdue tasks**: Past due date without completion

### Prioritization Scoring
```python
# Priority calculation factors
score = (
    urgency_weight * 30 +      # Time sensitivity
    value_weight * 25 +         # Deal amount
    activity_weight * 20 +      # Recent engagement
    stage_weight * 15 +         # Pipeline position
    task_weight * 10            # Pending tasks
)
```

### Categorization
| Category | Criteria | Action Type |
|----------|----------|-------------|
| Hot Lead | Score >100, recent activity | Immediate follow-up |
| Needs Attention | Missing fields, overdue | Data entry / outreach |
| Nurture | Low activity, early stage | Scheduled check-in |
| At Risk | No response, stale | Win-back strategy |

---

## Phase 3: Stage Files

**Git Equivalent**: Review changes, prepare for commit

### Data Preparation
- **Email extraction**: Parse Superhuman for deal-relevant emails
- **Volume data**: Gather monthly parcel counts from operations
- **Amount calculations**: Revenue based on volume × rate
- **Close dates**: Realistic timeline based on stage

### Validation Checks
```python
# Pre-update validation
REQUIRED_DEAL_FIELDS = [
    "dealname",
    "dealstage",
    "amount",
    "closedate",
    "hs_next_step",
    "notes_next_activity_date",  # Via tasks
    "description"
]

# Check for issues before updating
if not amount or amount == "0":
    flag_for_review("amount")
if not monthly_volume__c:
    flag_for_review("volume")
```

### Staging Queue
- Deals to update (properties)
- Tasks to create (follow-up dates)
- Notes to log (activity documentation)
- Stage movements (pipeline progression)

---

## Phase 4: Generate Message

**Git Equivalent**: Create meaningful commit message

### Next Step Generation
```python
STAGE_CONFIG = {
    "1090865183": {  # [01-DISCOVERY-SCHEDULED]
        "next_step": "Conduct discovery call - understand volume, pain points, timeline",
        "days_out": 3
    },
    "d607df25-2c6d-4a5d-9835-6ed1e4f4020a": {  # [04-PROPOSAL-SENT]
        "next_step": "Follow up on proposal - address questions, negotiate terms",
        "days_out": 5
    },
    "3fd46d94-78b4-452b-8704-62a338a210fb": {  # [07-STARTED-SHIPPING]
        "next_step": "QBR check-in - review performance, identify growth opportunities",
        "days_out": 30
    }
}
```

### Task Subject Generation
- Discovery: "Discovery call with {company}"
- Proposal: "Follow up on proposal - {company}"
- Implementation: "Check implementation status - {company}"
- QBR: "Quarterly review - {company}"

### Note Templates
```python
# Sync activity note
note_body = f"""
Sync Activity - {sync_type}
Date: {timestamp}
Action: {action_taken}
Next Step: {next_step}

Generated by Nebuchadnezzar v3.0
"""
```

---

## Phase 5: Handle Hooks

**Git Equivalent**: Pre-commit hooks, error handling

### API Error Handling
```python
# Common errors and solutions
HUBSPOT_ERRORS = {
    "read_only_property": {
        "field": "notes_next_activity_date",
        "solution": "Create task instead of setting directly"
    },
    "invalid_timestamp": {
        "cause": "ISO string instead of Unix ms",
        "solution": "Use str(int(datetime.timestamp() * 1000))"
    },
    "property_not_found": {
        "cause": "Wrong field name",
        "solution": "Query /crm/v3/properties/deals first"
    }
}
```

### Retry Logic
```python
def update_with_retry(deal_id, properties, max_retries=3):
    for attempt in range(max_retries):
        response = requests.patch(
            f"https://api.hubapi.com/crm/v3/objects/deals/{deal_id}",
            headers=headers,
            json={"properties": properties},
            timeout=10
        )
        if response.status_code == 200:
            return True
        elif response.status_code == 429:  # Rate limited
            time.sleep(2 ** attempt)
        else:
            log_error(response.text)
            break
    return False
```

### Validation Gates
- Division by zero protection
- Field name verification
- Timestamp format validation
- Association ID correctness

---

## Phase 6: Push Changes

**Git Equivalent**: Push to remote

### HubSpot Updates
```python
# Update deal properties
requests.patch(
    f"https://api.hubapi.com/crm/v3/objects/deals/{deal_id}",
    headers=headers,
    json={"properties": {
        "hs_next_step": next_step,
        "description": description,
        "amount": amount,
        "monthly_volume__c": volume
    }}
)

# Create follow-up task
requests.post(
    "https://api.hubapi.com/crm/v3/objects/tasks",
    headers=headers,
    json={
        "properties": {...},
        "associations": [{
            "to": {"id": deal_id},
            "types": [{"associationCategory": "HUBSPOT_DEFINED", "associationTypeId": 216}]
        }]
    }
)

# Log activity note
requests.post(
    "https://api.hubapi.com/crm/v3/objects/notes",
    headers=headers,
    json={
        "properties": {"hs_note_body": note_body, "hs_timestamp": timestamp},
        "associations": [{
            "to": {"id": deal_id},
            "types": [{"associationCategory": "HUBSPOT_DEFINED", "associationTypeId": 214}]
        }]
    }
)
```

### N8N Webhook Triggers
- Deal folder moves trigger automation
- Stage changes notify team
- High-value deals alert management

---

## Phase 7: Verification

**Git Equivalent**: Confirm push, report summary

### Sync Report Generation
```markdown
# SYNC REPORT - {sync_type}

## Pipeline Snapshot
- Total Active Deals: 40
- Total Pipeline Value: $85,096,234
- Deal Completeness: 100% (40/40)

## Updates Made
| Deal | Action | Result |
|------|--------|--------|
| BoxiiShip AF | Updated volume | ✅ 50,000 |
| Athleta | Updated volume | ✅ 100,000 |

## Tasks Created
- 40 follow-up tasks with stage-appropriate due dates

## Next Actions
1. [108pts] Upstate Prep - Monitor implementation
2. [89pts] BoxiiShip AF - Follow up on proposal
3. [88pts] Josh's Frogs - Schedule discovery call
```

### Continuity Chain
```python
# Update daily log for next sync
with open("_DAILY_LOG.md", "a") as f:
    f.write(f"\n## {date}\n")
    f.write(f"- Sync type: {sync_type}\n")
    f.write(f"- Deals updated: {count}\n")
    f.write(f"- Tasks created: {task_count}\n")

# Update follow-up reminders
with open("FOLLOW_UP_REMINDERS.txt", "w") as f:
    for action in priority_actions:
        f.write(f"{action}\n")
```

### Output Locations
- `sync_reports/` - Timestamped sync outputs
- `_DAILY_LOG.md` - Continuity for next session
- `FOLLOW_UP_REMINDERS.txt` - Action queue

---

## Daily Operations Mapped to Phases

### Morning Sync (9AM)
| Phase | Operation |
|-------|-----------|
| 1. Assess | Extract emails, fetch HubSpot status |
| 2. Analyze | Prioritize deals, identify gaps |
| 3. Stage | Queue updates, validate data |
| 4. Generate | Create next steps, task subjects |
| 5. Handle | Retry failures, validate formats |
| 6. Push | Update HubSpot, create tasks |
| 7. Verify | Generate report, update logs |

### Deal Hygiene Update
| Phase | Operation |
|-------|-----------|
| 1. Assess | Audit all deals for missing fields |
| 2. Analyze | Categorize by missing field type |
| 3. Stage | Gather amounts, volumes, dates |
| 4. Generate | Stage-based next steps |
| 5. Handle | Read-only field workarounds |
| 6. Push | Bulk update deals, create tasks |
| 7. Verify | Confirm 100% completeness |

### Weekly Sync
| Phase | Operation |
|-------|-----------|
| 1. Assess | Full pipeline review, week summary |
| 2. Analyze | Win/loss analysis, stage velocity |
| 3. Stage | Prepare comprehensive updates |
| 4. Generate | Weekly priorities, Monday actions |
| 5. Handle | Clean up stale data |
| 6. Push | All updates, comprehensive notes |
| 7. Verify | Full audit report, next week prep |

---

## Command Mapping

| Command | Primary Phases | Purpose |
|---------|----------------|---------|
| `/sync 9am` | 1-2-6-7 | Quick morning status |
| `/sync noon` | 1-2-7 | Mid-day check |
| `/sync eod` | 1-2-3-6-7 | End of day wrap |
| `/sync weekly` | All 7 | Comprehensive review |
| `/sync-learnings` | 2-3-4-6-7 | Documentation updates |
| `/git-sync` | All 7 | Code commits |

---

*Framework created: November 22, 2025*
*System: Nebuchadnezzar v3.0*
